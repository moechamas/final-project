{"ast":null,"code":"const {\n  createCipheriv,\n  createDecipheriv,\n  getCiphers\n} = require('crypto');\nconst uint64be = require('../help/uint64be');\nconst timingSafeEqual = require('../help/timing_safe_equal');\nconst {\n  KEYOBJECT\n} = require('../help/consts');\nconst {\n  JWEInvalid,\n  JWEDecryptionFailed\n} = require('../errors');\nconst checkInput = function (size, iv, tag) {\n  if (iv.length !== 16) {\n    throw new JWEInvalid('invalid iv');\n  }\n  if (arguments.length === 3) {\n    if (tag.length !== size / 8) {\n      throw new JWEInvalid('invalid tag');\n    }\n  }\n};\nconst encrypt = (size, sign, {\n  [KEYOBJECT]: keyObject\n}, cleartext, {\n  iv,\n  aad = Buffer.alloc(0)\n}) => {\n  const key = keyObject.export();\n  checkInput(size, iv);\n  const keySize = size / 8;\n  const encKey = key.slice(keySize);\n  const cipher = createCipheriv(`aes-${size}-cbc`, encKey, iv);\n  const ciphertext = Buffer.concat([cipher.update(cleartext), cipher.final()]);\n  const macData = Buffer.concat([aad, iv, ciphertext, uint64be(aad.length * 8)]);\n  const macKey = key.slice(0, keySize);\n  const tag = sign({\n    [KEYOBJECT]: macKey\n  }, macData).slice(0, keySize);\n  return {\n    ciphertext,\n    tag\n  };\n};\nconst decrypt = (size, sign, {\n  [KEYOBJECT]: keyObject\n}, ciphertext, {\n  iv,\n  tag = Buffer.alloc(0),\n  aad = Buffer.alloc(0)\n}) => {\n  checkInput(size, iv, tag);\n  const keySize = size / 8;\n  const key = keyObject.export();\n  const encKey = key.slice(keySize);\n  const macKey = key.slice(0, keySize);\n  const macData = Buffer.concat([aad, iv, ciphertext, uint64be(aad.length * 8)]);\n  const expectedTag = sign({\n    [KEYOBJECT]: macKey\n  }, macData, tag).slice(0, keySize);\n  const macCheckPassed = timingSafeEqual(tag, expectedTag);\n  if (!macCheckPassed) {\n    throw new JWEDecryptionFailed();\n  }\n  let cleartext;\n  try {\n    const cipher = createDecipheriv(`aes-${size}-cbc`, encKey, iv);\n    cleartext = Buffer.concat([cipher.update(ciphertext), cipher.final()]);\n  } catch (err) {}\n  if (!cleartext) {\n    throw new JWEDecryptionFailed();\n  }\n  return cleartext;\n};\nmodule.exports = (JWA, JWK) => {\n  ['A128CBC-HS256', 'A192CBC-HS384', 'A256CBC-HS512'].forEach(jwaAlg => {\n    const size = parseInt(jwaAlg.substr(1, 3), 10);\n    const sign = JWA.sign.get(`HS${size * 2}`);\n    if (getCiphers().includes(`aes-${size}-cbc`)) {\n      JWA.encrypt.set(jwaAlg, encrypt.bind(undefined, size, sign));\n      JWA.decrypt.set(jwaAlg, decrypt.bind(undefined, size, sign));\n      JWK.oct.encrypt[jwaAlg] = JWK.oct.decrypt[jwaAlg] = key => (key.use === 'enc' || key.use === undefined) && key.length / 2 === size;\n    }\n  });\n};","map":{"version":3,"names":["createCipheriv","createDecipheriv","getCiphers","require","uint64be","timingSafeEqual","KEYOBJECT","JWEInvalid","JWEDecryptionFailed","checkInput","size","iv","tag","length","arguments","encrypt","sign","keyObject","cleartext","aad","Buffer","alloc","key","export","keySize","encKey","slice","cipher","ciphertext","concat","update","final","macData","macKey","decrypt","expectedTag","macCheckPassed","err","module","exports","JWA","JWK","forEach","jwaAlg","parseInt","substr","get","includes","set","bind","undefined","oct","use"],"sources":["/Users/chamas/Final-Project/final-project/node_modules/jose/lib/jwa/aes_cbc_hmac_sha2.js"],"sourcesContent":["const { createCipheriv, createDecipheriv, getCiphers } = require('crypto')\n\nconst uint64be = require('../help/uint64be')\nconst timingSafeEqual = require('../help/timing_safe_equal')\nconst { KEYOBJECT } = require('../help/consts')\nconst { JWEInvalid, JWEDecryptionFailed } = require('../errors')\n\nconst checkInput = function (size, iv, tag) {\n  if (iv.length !== 16) {\n    throw new JWEInvalid('invalid iv')\n  }\n  if (arguments.length === 3) {\n    if (tag.length !== size / 8) {\n      throw new JWEInvalid('invalid tag')\n    }\n  }\n}\n\nconst encrypt = (size, sign, { [KEYOBJECT]: keyObject }, cleartext, { iv, aad = Buffer.alloc(0) }) => {\n  const key = keyObject.export()\n  checkInput(size, iv)\n\n  const keySize = size / 8\n  const encKey = key.slice(keySize)\n  const cipher = createCipheriv(`aes-${size}-cbc`, encKey, iv)\n  const ciphertext = Buffer.concat([cipher.update(cleartext), cipher.final()])\n  const macData = Buffer.concat([aad, iv, ciphertext, uint64be(aad.length * 8)])\n\n  const macKey = key.slice(0, keySize)\n  const tag = sign({ [KEYOBJECT]: macKey }, macData).slice(0, keySize)\n\n  return { ciphertext, tag }\n}\n\nconst decrypt = (size, sign, { [KEYOBJECT]: keyObject }, ciphertext, { iv, tag = Buffer.alloc(0), aad = Buffer.alloc(0) }) => {\n  checkInput(size, iv, tag)\n\n  const keySize = size / 8\n  const key = keyObject.export()\n  const encKey = key.slice(keySize)\n  const macKey = key.slice(0, keySize)\n\n  const macData = Buffer.concat([aad, iv, ciphertext, uint64be(aad.length * 8)])\n  const expectedTag = sign({ [KEYOBJECT]: macKey }, macData, tag).slice(0, keySize)\n  const macCheckPassed = timingSafeEqual(tag, expectedTag)\n\n  if (!macCheckPassed) {\n    throw new JWEDecryptionFailed()\n  }\n\n  let cleartext\n  try {\n    const cipher = createDecipheriv(`aes-${size}-cbc`, encKey, iv)\n    cleartext = Buffer.concat([cipher.update(ciphertext), cipher.final()])\n  } catch (err) {}\n\n  if (!cleartext) {\n    throw new JWEDecryptionFailed()\n  }\n\n  return cleartext\n}\n\nmodule.exports = (JWA, JWK) => {\n  ['A128CBC-HS256', 'A192CBC-HS384', 'A256CBC-HS512'].forEach((jwaAlg) => {\n    const size = parseInt(jwaAlg.substr(1, 3), 10)\n    const sign = JWA.sign.get(`HS${size * 2}`)\n    if (getCiphers().includes(`aes-${size}-cbc`)) {\n      JWA.encrypt.set(jwaAlg, encrypt.bind(undefined, size, sign))\n      JWA.decrypt.set(jwaAlg, decrypt.bind(undefined, size, sign))\n      JWK.oct.encrypt[jwaAlg] = JWK.oct.decrypt[jwaAlg] = key => (key.use === 'enc' || key.use === undefined) && key.length / 2 === size\n    }\n  })\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}